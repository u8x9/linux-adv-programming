# 第一章 Shell 脚本

## Shell概述

Shell的两层含义：既是一种应用程序，又是一种程序设计语言。

### 作为应用程序

交互式地解释、执行用户输入的命令，将用户的操作翻译成机器可以识别的语言，完成相应功能。

称之为 **Shell命令解析器**

Shell 是用户和 Linux 内核之间的接口程序。它调用了系统核心的大部分功能来执行程序，并以并行的方式协调各个程序的运行。

### 作为程序设计语言

它定义了各种变量和参数，并提供了许多在高级语言中才具有的控制结构，简化对系统的管理与应用程序的部署，称之为**Shell脚本**。

Shell 脚本是 Shell 命令的有序结合。

## Shell 语法

### shell 脚本的定义与执行

以 `#!/usr/bin/bash` 开头，声明脚本由什么 shell 解析器执行。

### 变量

#### 自定义变量

定义变量

```
变量名=变量值
如：num=10
```

引用变量

```
$变量名
如：i=$num
```

显示变量

```
echo $num
```

清除变量

```
unset 变量名
如：unset num
```

变量的其它用法

+ `read str` 从键盘输入一个字符串给变量 `str`

+ `readonly var=100` 定义一个只读变量，只能在定义时初始化，以后不能改变，不能被清除

+ `export var=300` 将变量导出为环境变量，其它 shell 均可使用

#### 环境变量

shell 在开始执行时就已经定义了一些和系统有关的变量，我们在shell中可以直接使用。

传统上，环境变量一般为大写。

显示环境变量

使用 `env` 可以查看所有环境变量

#### 预设变量

|变量|说明|
|----|----|
|`$#`|传给shell脚本参数的数量|
|`$*`|传给shell脚本参数的内容|
|`$1, $2...$9`|传递给shello脚本的参数，用空格隔开|
|`$?`|命令执行后返回的状态，成功：0；失败：非0|
|`$0`|当前执行的进程名|
|`$$`|当前进程的进程号|

#### 变量的特殊用法

+ `""`(双引号)：包含的变量会被解释

+ `''`(单引号)：包含的变量会当做字符串解释

+ <code>&#96;&#96;</code>：反引号中的内容作为系统命令，并执行

+ `$()`：与反引号相同

+ `\转义字符`：如果要使用C语言中的`\t, \n`等转义字符，需要给 `echo` 命令加上 `-e` 选项

+ `(命令序列)`：由子 Shell 来完成，不影响当前 Shell 中的变量

+ `{ 命令序列 }`：在当前 Shell 中执行，会影响当前变量(***注意 `{`和`}`前后有空格***)

### 条件测试语句

`test` 命令

用于测试字符串、文件状态和数字

语法格式：

```
test condition
或
[ codition ]
```

> 使用中括号时，要注意在条件两边加上空格

#### 文件测试

##### 按照文件类型

|条件|说明|
|----|----|
|`-e 文件名`|文件是否存在|
|`-s 文件名`|是否为非空|
|`-b 文件名`|是否块设备文件|
|`-c 文件名`|是否字符设备文件|
|`-d 文件名`|目录文件|
|`-f 文件名`|普通文件|
|`-L 文件名`|软链接文件|
|`-S 文件名`|套接字文件|
|`-p 文件名`|管道文件|

##### 按照文件权限

|条件|说明|
|----|----|
|`-r 文件名`|可读|
|`-w 文件名`|可写|
|`-x 文件名`|可执行|

##### 两个文件之间的比较

|条件|说明|
|----|----|
|`文件1 -nt 文件2`|`文件1`的修改时间是否比`文件2`**新**|
|`文件1 -ot 文件2`|`文件1`的修改时间是否比`文件2`**旧**|
|`文件1 -ef 文件2`|两个文件的inode节点号是否一样，用于判断是否是硬链接|

#### 字符串测试

|条件|说明|
|----|----|
|`s1 = s2`|两个字符串内容是否一样|
|`s1 != s2`|两个字符串内容是否不一样|
|`-z s1`|`s1`的长度是否为0|
|`-n s1`|`s1`的长度是否不为0|

#### 数字测试

|条件|说明|
|----|----|
|`a -eq b`|是否相等|
|`a -ne b`|是否不相等|
|`a -gt b`|大于|
|`a -ge b`|大于等于|
|`a -lt b`|小于|
|`a -le b`|小于等于|

#### 复合测试

##### 命令执行控制

|命令|说明|
|----|----|
|`cmd1 && cmd2`|`cmd1` 执行成功(即返回0) shell 才执行 `cmd2`|
|`cmd1 || cmd2`|`cmd1` 执行失败(即返回非0) shell 才执行 `cmd2`|

##### 多重条件判定

|条件|说明|
|----|----|
|`-a`|(and)两状况同时成立<br>`[ -r file -a -x file ]` file 同时具有读和执行权限才为真|
|`-o`|(or)两状况任一成立<br>`[ -r file -o -x file ]` file 具有读或可执行权限就为真|
|`!`|(not)取反<br>`[ ! -x file ]` file 不具有可执行权限返回真|

### 控制语句

#### `if`

格式一：

```bash
if [ 条件1 ]; then
    执行第一段程序
else
    执行第二段程序
fi
```

格式二：

```bash
if [ 条件1 ]; then
    执行第一段程序
elif [ 条件2 ]; then
    执行第二段程序
else
    执行第三段程序
fi
```

#### `case`

```bash
case $变量名称 in
    "第一个变量内容" )
        程序段一
        ;;
    "第二个变量内容" )
        程序段二
        ;;
    *)
        其它程序段
        ;;
esac
```

#### `for`

形式一：

```bash
for ((初始值; 限制值; 步阶))
do
    程序段
done
```

`declare` 是一个内建命令，可以用来声明变量、设置变量的属性，也可以写作 `typeset`

`declare -i s` 表示强制把 `s` 变量当做整型

形式二：

```bash
for var in con1 con2 con3 ...
do
    程序段
done
```

> 第一次循环时，$var 的内容为 con1
> 
> 第二次循环时，$var 的内容为 con2
>
> 第三次循环时，$var 的内容为 con3
>
> ...

#### `while`

```bash
while [ 条件 ]
do
    程序段
done
```

#### `until`

```bash
until [ 条件 ]
do
    程序段
done
```

> 与 `while` 相反，`until` 是当条件成立时，退出循环

#### `break` / `continue`

### 函数

定义形式一：

```bash
函数名(){
    命令...
}
```

定义形式二：

```bash
function 函数名(){
    命令...
}
```

> 函数在使用前必须定义，通常将函数定义放在脚本开始部分

调用格式

```bash
函数名 参数1 参数2 ...
```

函数内获取传递过来的参数

> 和脚本参数一样 `$1 $2 ...`

```bash
$1, $2, $3 ...
```

返回值

`return` 从函数中返回，用最后状态命令决定返回值。

```bash
return 0 # 无错误返回
return 1 # 有错误返回
```